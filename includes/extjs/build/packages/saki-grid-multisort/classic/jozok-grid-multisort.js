Ext.define("Ext.jozok.grid.MultiSort",{extend:"Ext.grid.feature.Feature",alternateClassName:"Ext.ux.grid.MultiSort",alias:["feature.ux-gmsrt","feature.jozok-gmsrt"],removeSortText:"Remove from Sort",displaySortOrder:false,config:{sortersCount:0},init:function(b){var c=this,a=c.view,d=a.headerCt;c.callParent(arguments);a.on({afterrender:{fn:c.afterViewRender,scope:c}});d.on({headerclick:{fn:c.onHeaderClick,scope:c}});d.onHeaderCtEvent=function(h,f){var g=d.sortOnClick;if(h.altKey){d.sortOnClick=false}Ext.grid.header.Container.prototype.onHeaderCtEvent.apply(d,[h,f]);d.sortOnClick=g}},afterViewRender:function(){var a=this;a.injectMultiSortMenu();if(!a.grid.viewModel){a.updateSorteredColumns()}else{a.setSortersCount(0)}},onHeaderClick:function(c,d,h){var f=this,b=f.view.getStore(),i,g="ASC",a=Ext.versions.extjs.major;f.removeOldSorterLabels();if(h.altKey&&a>4){i=b.sorters.getByKey(d.dataIndex);if(i){if(i.direction!=="DESC"){i.setDirection("DESC")}else{i.setDirection("ASC")}d.setSortState(i);b.sort()}else{d.setSortState(i);d.enableRemSortItem=true;f.setSortersCount(f.getSortersCount()+1);b.sort(d.dataIndex,g,"append")}}f.updateSorteredColumns()},injectMultiSortMenu:function(){var a=this,b=a.view.headerCt;if(b.sortable){b.getMenuItems=a.getMenuItems();b.getMenu().on({beforeshow:function(c){c.down("#remSortItem").setDisabled(!c.activeHeader.enableRemSortItem)}})}},removeOldSorterLabels:function(){var a=this,b=a.view.headerCt;Ext.each(b.getGridColumns(),function(c){c.enableRemSortItem=false;if(a.displaySortOrder){c.setText(c.text.split(" <small>(")[0])}})},updateSorteredColumns:function(){var e=this,b=e.view.getStore(),a,f=b.sorters,h,g,d,c;e.setSortersCount(f.getCount());for(c=0;c<e.getSortersCount();c++){h=f.getAt(c);d=h.property||h.getProperty();a=e.view.headerCt.down("[dataIndex="+d+"]");if(a){a.enableRemSortItem=true;e.setSortState(a,h);if(e.displaySortOrder){g=a.text.split(" <small>");a.setText(g[0]+" <small>("+(c+1)+")</small>")}}}},getMenuItems:function(){var b=this,c=b.view.headerCt,a=c.getMenuItems;return function(){var e=a.call(this),d=e.length;Ext.each(e,function(g,f){if(g.itemId==="ascItem"){g.text="Add "+g.text;g.handler=b.onSortAscClick;g.scope=b}if(g.itemId==="descItem"){g.text="Add "+g.text;g.handler=b.onSortDescClick;g.scope=b;d=f+1}});Ext.Array.insert(e,d,[{itemId:"remSortItem",text:b.removeSortText,iconCls:b.menuSortDescCls,handler:b.onRemoveSortClick,disabled:true,scope:b}]);return e}},onRemoveSortClick:function(){var g=this,b=g.view.headerCt,a=b.getMenu(),c=a.activeHeader,h=c.dataIndex,i=g.view.getStore(),f=i.sorters,j=c.text.split(" <small>("),k=c.ascSortCls,d=c.descSortCls,e=Ext.versions.extjs.major,l;c.removeCls([k,d]);l=f.getByKey(h);if(l){if(!(e<5)){l.isFilter=true}f.removeAtKey(h)}b.fireEvent("sortchange",b,c);if(e<5){i.sort()}if(g.displaySortOrder){c.setText(j[0]);g.updateSorteredColumns()}c.enableRemSortItem=false;if(f.length===0&&i.remoteSort){i.load()}},onSortClick:function(f){var e=this,a=e.view.headerCt.getMenu(),b=a.activeHeader,g=b.dataIndex,i=b.text.split(" <small>("),h=e.view.getStore(),d=h.sorters,j=d.getByKey(g),c=Ext.versions.extjs.major;if(c<5){b.setSortState(f,true,true)}else{if(j){b.setSortState(j)}}b.enableRemSortItem=true;if(j){d.removeAtKey(g);if(e.displaySortOrder){b.setText(i[0]);e.updateSorteredColumns()}}e.setSortersCount(e.getSortersCount()+1);if(e.displaySortOrder){b.setText(b.text+" <small>("+e.getSortersCount()+")</small>")}if(c<5){d.add(Ext.create("Ext.util.Sorter",{property:g,direction:f,id:g}));if(h.remoteSort){h.sort()}else{e.sortLocalSortingStore()}}else{h.sort(g,f,"append")}},onSortAscClick:function(){this.onSortClick("ASC")},onSortDescClick:function(){this.onSortClick("DESC")},setSortState:function(b,c){var a=Ext.versions.extjs.major;if(a<5){b.setSortState(c.direction,true,true)}else{if(c){b.setSortState(c)}}},sortLocalSortingStore:function(){var c=this,a=c.view.getStore(),g=a.sorters,h,e=[],b,d,f;for(b=0;b<g.getCount();b++){h=g.getAt(b);d=h.property||h.getProperty();f=h.direction||h.getDirection();e.push({property:d,direction:f})}e.push({property:d,direction:f});a.sort(e)}});